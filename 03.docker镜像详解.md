# 03. 镜像详解
## 一基本原理
1. docker 为什么分层
最大的好处就是可以-共享资源
比如：有多个镜像都可以从相同的base镜像构建而来，那么宿主机只需要在磁盘上保存一份base镜像。
同时内存中也只需要加载一份base镜像，就可以为所有容器服务了。而且镜像的每一层都可以被共享。




## 二 容器高级命令
1. commit 
```shell
docker commit 提交容器副本使之成为一个新的镜像
docker commit -m='提交的描述信息' -a='作者' 容器ID 要创建的目标镜像名：【标签名】
例如：
docker commit -a='zhu' -m='tomcat not docs' c623aec78f3c  zhu/mytomcat:1.0
```
案例演示：
```shell
1. 从Hub上下载tomcat镜像到本地并成功运行
2. 故意删除上一步镜像生产tomcat容器的文档
```


## 三 容器数据卷
1. 为啥用卷
docker 原理
- 将运用于运行的环境打包形成容器运行，运行可以伴随着容器，但是我们对数据的要求希望是持久化的
- 容器之间希望有可能共享数据

Docker 容器产生的数据，如果不通过docker commit生成新的镜像，使得数据做为镜像的一部分保存下来那么容器删除后数据自然没了。

为了能保存数据在docker中我们使用卷

2. 数据卷添加
- 直接命令添加
docker run -it -v /宿主机目录:/容器目录 镜像名
docker run -it -v /宿主机目录:/容器目录:ro 镜像名  # 镜像对文件只读不可写

- DockerFile添加  
注意：  
在DockerFile中添加一个或者多个数据卷时需要使用指令VOLUME  
VOLUME=['/data/container1','/data/container2','/data/container3']  
原因：  
由于可移植和分享的考虑，用-v 主机目录：容器目录这种方法不能够直接在Dockerfile中实现，由于宿主机目录是依赖于特定宿主机的，并不能够保证所在的宿主机上都存在这样的特定目录

- 创建DockerFile文件
```shell
#volume test
FROM centos
VOLUME ["/contain1","/contain2"] # 这里要用双引号不要用单引号
CMD echo "successful"
CMD /bin/bash

保存到文件中
然后执行命令
docker 建立 -f 指定文件   -t 指定镜像存储库 指定当前目录
docker build -f Dockerfile -t zhu/centos . 
```
- 有关问题
Docker 挂在主机目录Docker访问出现cannot open directory .:Permissin denied
解决方法：在挂载目录后多一个--privileged=True参数即可
```shell
docker run -it -v /my1:/container1  --privileged=true 镜像名
```

## 四 数据卷容器
- 含义
命名的容器挂在数据卷，其它容器通过挂载这个（父容器）实现数据共享，挂载数据卷的容器，称之为数据卷容器

白话文理解：父容器挂载数据卷1 子容器都挂载，都可以共享该数据卷

- 实验
其中zhu/centos中有两个数据卷contain1 contain2
1. 创建doc1
```shell
docker run -it --name doc1 zhu/centos
进入目录contain1创建文件doc1.txt
```
2. 创建doc2 父类数据卷doc1
```shell
docker run -it --name doc2 --volumes-from doc1 zhu/centos
进入目录contain1创建文件doc2.txt
```
3. 在doc1 与doc2 中查看是否存在doc1.txt、doc2.txt
4. 创建doc4 父类数据卷doc1
```shell
docker run -it --name doc3 --volumes-from doc1 zhu/centos
进入目录contain1创建文件doc3.txt
```
5. 在doc1、doc2、doc3中 中查看是否存在doc1.txt、doc2.txt、doc3.txt
6. 删除doc1 查看doc2与doc3中是否存在文件
7. 创建doc4 父容器doc2
```shell
docker run -it --name doc4 --volumes-from doc2 zhu/centos
进入目录contain1创建文件doc4.txt
```
8. 在doc1、doc2、doc4中 中查看是否存在doc1.txt、doc2.txt、doc3.txt、doc4.txt
以上文件都存在

==以上结论：== 容器之间配置信息的传递，数据卷的生命周期一直持续到没有容器使用它为止
## 五 DockerFile文件详解
- 创建文件的整个过程
1. 手动编写一个dockerfile文件，当然，必须要符合file的规范
2. 有这个文件后，直接docker build 命令执行，获得一个自定义的镜像
3. run
- Dockerfile 内容基础知识
1. 每条保留字指令都必须为大写字母且后面要跟随至少一个参数
2. 指令按照从上到下，顺序执行。
3. #表示注释
4. 每条指令都会创建一个新的镜像层，并对镜像进行提交。
- Docker执行Dockerfile的大致流程
1. docker 从基础镜像运行一个容器
2. 执行一条指令并对容器作出修改
3. 执行类似docker commit 的操作提交一个新的镜像层
4. docker 再基于刚提交的镜像运行一个新容器
5. 执行dockerfile中的下一条指令，直到执行完成
- 从应用软件的角度看
1. Dockerfile 是软件的原材料
2. Docker 镜像是软件的交付品
3. Docker 容器则可以认为是软件的运行态

- Dcokerfile语法

    FROM 
    ```shell
    基础镜像，当前新镜像是基于那个镜像的 
    ```
    MAINTAINER 
    
    ```shell
    镜像维护者的姓名和邮箱地址  
    ```
    RUN 
    ```shell
    容器构建时需要运行的命令,运行Linux 比如mkdir test  
    ```
    EXPOSE 
    ```shell
    开发端口，对外提供的端口号  
    ```
    WORKDIR 
    ```shell
    指定再创建容器后，终端默认登录进来的工作目录，一个落脚点  
    ```
    ENV 
    ```shell
    这个环境变量可以在后续中使用  
        例如:ENV MY_PATH /usr/mytest  
            WORKDIR $MY_PATH  
    ```
    ADD 
    ```shell
    将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar压缩包  
    ```
    COPY 
    ```shell
    类似ADD 拷贝文件和目录到镜像中。将从构建上下文目录中<源路径>的文件/目录复制到新的一层的镜像内<目录路径>位
    ```
    VOLUME 
    ```shell
    容器数据卷，用户数据保存和持久化工作  
    ```
    CMD 
    ```shell
    1. 指定一个容器启动时要运行的命令  
    2. Dockerfile中有多个CMD命令，但只有最有一个生效，CMDh会被docker run 之后的参数替换掉。  
    例如：CMD ['/bin/bash']与
    docker run -it centos /bin/bash 等价
    如果最后不加 /bin/bash 
    docker run -it centos 那么会使用文件中的CMD
    ```
    ENTRYPOINT
    ```shell
    1.docker run 之后的参数会被当前做参数传递给ENTRYPOINT，之后形成新的命令组合，与CMD不同就是，该参数命令不会被覆盖，而是追加
    例如：CMD curl -s https://ip.cn
        ENTRYPOINT curl -s https://ip.cn
        使用docker run myip -i
        使用CMD 时-i会覆盖变为：-i
        使用ENTRYPOINT 时-i会追加为：curl -s -i https://ip.cn
    ```
    ONBUILD
    ```shell
    当构建一个被继承的Dockerfile时运行命令，父镜像在被子继承后父镜像的onbuild触发
    ```
- 案例1：使用Dockerfile自定义mycentos
创建一个带有vim 和net-tools的文件
```shell
FROM centos
MAINTAINER zhu<zhugxu@139.com>
ENV MY_PATH /data

WORKDIR $MY_PATH
RUN yum -y install vim
RUN yum -y install net-tools

EXPOSE 80
CMD echo $MY_PATH
CMD echo "successful"
CMD /bin/bash
```
- 案例2：使用ONBUILD
```shell
FROM centos
MAINTAINER zhu<zhugxu@139.com>
RUN yum -y install curl
ENTRYPOINT curl -s https://baidu.com
ONBUILD RUN echo "hahahahah father image"
CDM ["/bin/bash"]
```
- 案例3 使用Tomcat
```shell
FROM centos 
```

## 五 安装数据库
- 安装Mysql数据库







